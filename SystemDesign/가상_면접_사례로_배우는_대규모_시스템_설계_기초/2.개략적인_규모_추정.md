시스템 설계 면접을 볼 때, 때로는 시스템 용량이나 성능 요구사항을 개략적으로 추정해보라는 요구를 받게 된다.

구글의 제프 딘에 따르면, “개략적인 규모 추정은 보편적으로 통용되는 성능 수치상에서 사고 실험을 행하여 추정치를 계산하는 행위로서, 어떤 설계가 요구사항에 부합할 것인지 보기 위한 것이다.

개략적 규모 추정을 효과적으로 해 내려면 규모 확장성을 표현하는 데 필요한 기본기에 능숙해야 한다. 특히, 2의 제곱수나 응답지연(latency) 값, 그리고 가용성에 관계된 수치들을 기본적으로 잘 이해하고 있어야 한다.

## 2의 제곱수

분산 시스템에서 다루는 데이터 양은 엄청나게 커질 수 있으나 그 계산법은 기본을 크게 벗어나지 않는다. 제대로 된 계산 결과를 얻으려면 데이터 볼륨의 단위를 2의 제곱수로 표현하면 어떻게 되는지를 우선 알아야 한다.

최소 단위는 1바이트이고, 8비트로 구성된다. ASCII 문자 하나가 차지하는 메모리 크기가 1바이트이다.

| 2의 x 제곱 | 근사치 | 이름 | 축약형 |
| --- | --- | --- | --- |
| 10 | 1천(thousand) | Kilobyte | 1KB |
| 20 | 1백만(million) | Megabyte | 1MB |
| 30 | 10억(billion) | Gigabyte | 1GB |
| 40 | 1조(trillion) | Terabyte | 1TB |
| 50 | 1000조(quadrillion) | Petabyte | 1PB |

## 응답지연 값

구글의 제프 딘은 2010년에 통상적인 컴퓨터에서 구현된 연산들의 응답지연 값을 공개한 바 있다.

이들 가운데 몇몇은 더 빠른 컴퓨터가 등장하면서 ㄷ더 이상 유효하지 않게 되었지만, 아직도 이 수치들은 컴퓨터 연산들의 처리속도가 어느정도인지 짐작할 수 있도록 해준다.

| 연산명 | 시간 |
| --- | --- |
| L1 캐시 참조 | 0.5ns |
| 분기 예측 오류 (branch mispredict) | 5ns |
| L2 캐시 참조 | 7ns |
| 뮤텍스(mutex) 락/언락 | 100ns |
| 주 메모리 참조 | 100ns |
| Zippy로 1KB 압축 | 0.01ms |
| 1Gbps 네트워크로 2KB 전송 | 0.02ms |
| 메모리에서 1MB 순차적으로 read | 0.25ms |
| 같은 데이터 센터 내에서의 메시지 왕복 지연시간 | 0.5ms |
| 디스크 탐색(seek) | 10ms |
| 네트워크에서 1MB 순차적으로 read | 10ms |
| 디스크에서 1MB 순차적으로 read | 30ms |
| 한 패킷의 CA(캘리포니아)로부터 네덜란드까지의 왕복 지연시간 | 150ms |

L1 캐시 참조 - 1ns

분기 예측 오류 - 3ns

L2 캐시 참조 - 4ns

뮤텍스 락/언락 - 17ns

일반 상용 네트워크상에서 2K바이트 전송 : 44ns

SDD상에서 임의 위치의 데이터 읽기 -16us

SDD상에서 1M바이트 순차적 읽기 - 49us

메모리에서 1M바이트 순차적 읽기 : 3us

동일 데이터 센터 내에서의 패킷 왕복 지연 시간 - 500us

디스크에서 1M 바이트 순차적 읽기 : 825us

CA에서 네덜란드까지의 패킷 왕복 지연시간 - 150ms

- 메모리는 빠르지만 디스크는 아직도 느리다.
- 디스크 탐색(seek)은 가능한 피하라.
- 단순한 압축 알고리즘은 빠르다.
- 데이터를 인터넷으로 전송하기 전에 가능하면 압축하라.
- 데이터 센터는 보통 여러 지역에 분산되어 있고, 센터들 간에 데이터를 주고받는 데는 시간이 걸린다.

## 가용성에 관계된 수치들

고가용성(high availability : HA)은 시스템이 오랜 시간 동안 지속적으로 중단 없이 운영될 수 있는 능력

고가용성은 퍼센트로 표현하는데, 100%는 시스템이 단 한번도 중단된 적이 없었음을 의미

대부분 서비스는 99% ~ 100% 사이의 값을 갖는다.

SLA(Service Level Agreenent)는 서비스 사업자가 보편적으로 사용하는 언어로, 서비스 사업자와 고객 사이에 맺어진 합의를 의미

이 합의에는 제공되는 서비스의 가용시간(uptime)이 공식적으로 기술되어 있다.

가용시간은 관습적으로 숫자 9를 사용해 표시하며, 9가 많을 수록 좋다.

| 가용률 | 하루당 장애시간 | 주당 장애시간 | 개월당 장애시간 | 연간 장애시간 |
| --- | --- | --- | --- | --- |
| 99% | 14.40분 | 1.68시간 | 7.31시간 | 3.65일 |
| 99.9% | 1.44분 | 10.08분 | 43.83분 | 8.77시간 |
| 99.99% | 8.64초 | 1.01분 | 4.38분 | 52.60분 |
| 99.999% | 864밀리초 | 6.05초 | 26.30초 | 5.26분 |
| 99.9999% | 86.4밀리초 | 604.80밀리초 | 2.63초 | 31.56초 |

## 예제 : 트위터 QPS와 저장소 요구량 추정

제시된 데이터는 실제 성능이 아님.

### 가정

- 월간 능동 사용자(monthly active user)는 3억명
- 50%의 사용자가 트위터를 매일 사용
- 평균적으로 각 사용자는 매일 2건의 트윗을 함
- 미디어를 포함하는 트윗은 10%
- 데이터는 5년간 보관

### 추정

QPS(Query Per Second) 추정치

- 일간 능동 사용자(Daily Active User, DAU) = 3억 * 50% = 1.5억
- QPS = 1.5억 * 2트윗 / 24시간 / 3600초 = 약 3500
- 최대 QPS = 2 * QPS = 약 7000

### 미디어 저장을 위한 저장 요구량

- 평균 트윗 크기
    - tweet_id에 64바이트
    - 텍스트에 140바이트
    - 미디어에 1MB
- 미디어 저장 요구량 : 1.5djr * 2 * 10% * 1MB = 30TB / 일
- 5년간 미디어를 보관하기 위한 저장소 요구량 : 30TB * 365 * 5 = 약 55PB

## 팁

개략적인 규모 추정과 관계된 면접에서 가장 중요한 것은 문제를 풀어 나가는 절차다.

- 근사치를 활용한 계산(rounding and approxination) : 면접장에서 복잡한 계산을 하는 것은 어려운 일이다. 계산 결과의 정확함을 평가하는 것이 목적이 아니라서다. 그러니 적절한 근사치를 활용하자.
- 가정(assumption)들은 적어두라.
- 단위(unit)를 붙여라 5라고만 적으면 5KB인지 5MB인지 알 수가 없다.
- 많이 출제되는 개략적 규모 추정 문제는 QPS, 최대 QPS, 저장소 요구량, 캐시 요구량, 서버 수 등을 추정하는 것